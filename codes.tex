\section{Algorithms}
\label{app:codes}
In this section, we show several important algorithms including timestamp stack and queue, lazy set, skip-list sets and skip-list priority queue.
\begin{figure}[h]
\begin{tikzpicture}[]
\node(top){};
\node(top-head)[linecode] at ($(top.west)+(-60pt,0pt)$) {};
%%%%%%%%%%% struct %%%%%%%%%%%%%%%%
\node[linecode,anchor=south west](struct) at ($(top-head.east)+(-30pt,0pt)$) { \scriptsize struct Node \scriptsize \{};
%{struct Node(bool lock; int val; Node *next; bool mark);};
\node(struct1)[linecode] at ($(top-head.west)+(10pt,-5pt)$) {\scriptsize int data;\;\;};
\node(struct2)[linecode] at ($(top-head.west)+(10pt,-15pt)$) {\scriptsize Timestamp ts;};
\node(struct3)[linecode] at ($(top-head.west)+(10pt,-26pt)$) {\scriptsize Node* next;};
\node(struct4)[linecode] at ($(top-head.west)+(10pt,-37pt)$) {\scriptsize bool mark;};
\node(struct5)[linecode] at ($(top-head.west)+(0pt,-47pt)$) {\scriptsize \}};
\node(struct6)[linecode] at ($(top-head.west)+(0pt,-52pt)$) {}; 
\begin{pgfonlayer}{background}
 \node[code-bg,fit=(struct) (struct6) (struct1) (struct2)] {};
\end{pgfonlayer}


\node(locate-head)[linecode] at ($(top-head.east)+(143pt,8pt)$) {\scriptsize int pop(Timestamp ts):};

\node(locate1)[linenum,anchor=west] at ($(locate-head.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate1.east)+(0pt,0pt)$) {\scriptsize boolean success = false;};

\node(locate2)[linenum] at ($(locate1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate2.east)+(0pt,0pt)$) {\scriptsize int maxTS = -1;};

\node(locate3)[linenum] at ($(locate2.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(locate3.east)+(0pt,0pt)$) {\scriptsize Node* youngest, myTop, n = null;};

\node(locate3a)[linenum] at ($(locate3.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(locate3a.east)+(0pt,0pt)$) {\scriptsize Node* empty[maxThreads];};

\node(locate4)[linenum] at ($(locate3a.east)+(0pt,-10pt)$) {};
\node(code4)[linecode] at ($(locate4.east)+(0pt,0pt)$) {\scriptsize while (!success)}; 

\node(locate5)[linenum] at ($(locate4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate5.east)+(7pt,0pt)$) {\scriptsize int k; };

\node(locate6)[linenum] at ($(locate5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate6.east)+(7pt,0pt)$) {\scriptsize for(int i=0; i<maxThreads; i++)};

\node(locate7)[linenum] at ($(locate6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate7.east)+(14pt,0pt)$) {\scriptsize myTop = pools[i]; n = myTop;};

\node(locate8)[linenum] at ($(locate7.east)+(0pt,-10pt)$) {};
\node(code8)[linecode] at ($(locate8.east)+(14pt,0pt)$) {\scriptsize while (n.mark \&\& n.next != n) n = n.next; };


\node(locate8a)[linenum] at ($(locate8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8a.east)+(14pt,0pt)$) {\scriptsize if(n = null)};


\node(locate8b)[linenum] at ($(locate8a.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8b.east)+(21pt,0pt)$) {\scriptsize empty[i] = pools[i];};

\node(locate8c)[linenum] at ($(locate8b.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8c.east)+(21pt,0pt)$) {\scriptsize continue;};

\node(locate9a)[linenum] at ($(locate8c.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9a.east)+(14pt,0pt)$) {\scriptsize if(st < n.ts)};

\node(locate9b)[linenum] at ($(locate9a.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9b.east)+(21pt,0pt)$) {\scriptsize r = remove(pools[i], top, n);};

\node(locate9c)[linenum] at ($(locate9b.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9c.east)+(21pt,0pt)$) {\scriptsize return n.data);};


\node(locate9)[linenum] at ($(locate9c.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9.east)+(14pt,0pt)$) {\scriptsize if(maxTS < n.ts)};

\node(locate10)[linenum] at ($(locate9.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate10.east)+(21pt,0pt)$) {\scriptsize maxTS = n.ts;};

\node(locate11)[linenum] at ($(locate10.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate11.east)+(21pt,0pt)$) {\scriptsize youngest = n;};

\node(locate12)[linenum] at ($(locate11.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate12.east)+(21pt,0pt)$) {\scriptsize k = i;};

\node(locate13)[linenum] at ($(locate12.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate13.east)+(7pt,0pt)$) {\scriptsize if (youngest != null)};

\node(locate14)[linenum] at ($(locate13.east)+(0pt,-10pt)$) {};
\node(code14)[linecode] at ($(locate14.east)+(14pt,0pt)$) {\scriptsize success= remove(pools[k],myTop, youngest);};

\node(locate15)[linenum] at ($(locate14.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate15.east)+(7pt,0pt)$) {\scriptsize if (youngest = null)};

\node(locate16)[linenum] at ($(locate15.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate16.east)+(14pt,0pt)$) {\scriptsize for(int i=0; i<maxThreads; i++)};

\node(locate17)[linenum] at ($(locate16.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate17.east)+(28pt,0pt)$) {\scriptsize if (pools[i] != empty[i]);};

\node(locate18)[linenum] at ($(locate17.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate18.east)+(35pt,0pt)$) {\scriptsize return NonEmpty;};


\node(locate19)[linenum] at ($(locate18.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate19.east)+(14pt,0pt)$) {\scriptsize return Empty;};

%\node(locate21)[linenum] at ($(locate19.east)+(0pt,-10pt)$) {\scriptsize 21};
%\node[linecode] at ($(locate21.east)+(28pt,0pt)$) {\scriptsize Node* next=youngest.next};
%
%\node(locate22)[linenum] at ($(locate21.east)+(0pt,-10pt)$) {\scriptsize 22};
%\node(code22)[linecode] at ($(locate22.east)+(28pt,0pt)$) {\scriptsize while (next.next != next $\&$ next.mark);};
%
%\node(locate23)[linenum] at ($(locate22.east)+(0pt,-10pt)$) {\scriptsize 23};
%\node[linecode] at ($(locate23.east)+(35pt,0pt)$) {\scriptsize next = next.next;};
%
%\node(locate24)[linenum] at ($(locate23.east)+(0pt,-10pt)$) {\scriptsize 24};
%\node[linecode] at ($(locate24.east)+(28pt,0pt)$) {\scriptsize youngest.next = next;};
%
\node(locate25)[linenum] at ($(locate19.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate25.east)+(0pt,0pt)$) {\scriptsize return youngest.data;};




\node(bot)[linecode] at ($(locate25.east)+(0pt,-10pt)$) {};
\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head) (code3) (locate14) (code22) (bot) ]{};
 \end{pgfonlayer}

%%%%%%%%%% pop %%%%%%%%%%



%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(pop-head)[linecode][font={\small\tt},anchor=west] at 
($(top-head.east)+(-30pt,-122pt)$) 
{\scriptsize void push(int d):};
\node(pop1)[linenum,anchor=west] at ($(pop-head.west)+(0pt,-10pt)$) {\scriptsize 1};
\node(linecode1)[linecode] at ($(pop1.east)+(0pt,0pt)$) 
{\scriptsize Node* new := new Node(d,-1,null,false);};

\node(pop2)[linenum] at ($(pop1.east)+(0pt,-10pt)$) {};
\node(linecode2)[linecode] at ($(pop2.east)+(0pt,0pt)$)
{\scriptsize new.next = pools[myID];};

\node(pop3)[linenum] at ($(pop2.east)+(0pt,-10pt)$) {};
\node(linecode3)[linecode] (code3a) at ($(pop3.east)+(0pt,0pt)$)
{\scriptsize pools[myID] = new;};

\node(pop4)[linenum] at ($(pop3.east)+(0pt,-10pt)$) {};
\node(linecode4)[linecode] at ($(pop4.east)+(0pt,0pt)$)
{\scriptsize  Timestamp t = new Timestamp();};

\node(pop5)[linenum] at ($(pop4.east)+(0pt,-10pt)$) {};
\node(linecode5)[linecode] at ($(pop5.east)+(0pt,0pt)$) 
{\scriptsize new.ts = t;};

\node(pop6)[linenum] at ($(pop5.east)+(0pt,-10pt)$) {};
\node(linecode6)[linecode] at ($(pop6.east)+(0pt,0pt)$) 
{\scriptsize Node* next = new.next;};

\node(pop7)[linenum] at ($(pop6.east)+(0pt,-10pt)$) {};
\node(linecode7)[linecode] at ($(pop7.east)+(0pt,0pt)$) 
{\scriptsize while (next.next != next $\&$ !next.mark)};

\node(pop8)[linenum] at ($(pop7.east)+(0pt,-10pt)$) {};
\node(linecode8)[linecode] at ($(pop8.east)+(7pt,0pt)$) 
{\scriptsize next = next.next;};

\node(pop9)[linenum] at ($(pop8.east)+(0pt,-10pt)$) {};
\node(linecode9)[linecode] at ($(pop9.east)+(0pt,0pt)$) 
{\scriptsize new.next = next;};

\node(pop10)[linenum] at ($(pop9.east)+(0pt,-10pt)$) {};
\node(linecode10)[linecode] at ($(pop10.east)+(0pt,0pt)$) 
{\scriptsize return new;};




%\node(bot)[linecode] at ($(pop10.east)+(0pt,-18pt)$) {};

\begin{pgfonlayer}{background}
\node[code-bg,fit=(pop-head) (linecode1) (pop1) (pop10)]{};
\end{pgfonlayer}
 
 
 
 %%%%%%%%%%% init %%%%%%%%%%%%%%%%
\node[linecode,anchor=south west](init) at ($(top-head.east)+(-30pt,-75pt)$) {\scriptsize init() :};
%{struct Node(bool lock; int val; Node *next; bool mark);};
\node(init1)[linecode] at ($(top-head.east)+(-30pt,-80pt)$) {\scriptsize \;\;\;Node* pools[maxThreads];};
\node(init2)[linecode] at ($(top-head.east)+(-30pt,-90pt)$) {\scriptsize \;\;\;for(int i=0; i<maxThreads; i++)};
\node(init4)[linecode] at ($(top-head.east)+(-30pt,-100pt)$) {\scriptsize \;\;\;\;\;\;\;pools[i].next = null;};

%\node(bot)[linecode] at ($(init4.east)+(0pt,-4pt)$) {};

\begin{pgfonlayer}{background}
 \node[code-bg,fit= (init) (init1) (init4) (init2)] {};
\end{pgfonlayer}






%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(pop-head1)[linecode][font={\scriptsize \tt},anchor=west] at  ($(top-head.east)+(-30pt,-242pt)$) {\scriptsize Node remove(Node* pt, Node* t, Node* n)};


\node(locate14)[linenum] at ($(pop-head1.west)+(10pt,-10pt)$) {};
\node(code14)[linecode] at ($(locate14.east)+(0pt,0pt)$) {\scriptsize bool s = CAS(n.mark,false,true);};

\node(locate15)[linenum] at ($(locate14.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate15.east)+(7pt,0pt)$) {\scriptsize if (s)};

\node(locate16)[linenum] at ($(locate15.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate16.east)+(14pt,0pt)$) {\scriptsize CAS(pt, t, n);};

\node(locate17)[linenum] at ($(locate16.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate17.east)+(14pt,0pt)$) {\scriptsize if (t != n);};

\node(locate18)[linenum] at ($(locate17.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate18.east)+(21pt,0pt)$) {\scriptsize t.next = n;};


\node(locate19)[linenum] at ($(locate18.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate19.east)+(14pt,0pt)$) {\scriptsize t.next = n.next;};

\node(locate21)[linenum] at ($(locate19.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate21.east)+(14pt,0pt)$) {\scriptsize Node* next=n.next};

\node(locate22)[linenum] at ($(locate21.east)+(0pt,-10pt)$) {};
\node(code22)[linecode] at ($(locate22.east)+(14pt,0pt)$) {\scriptsize while (next.next!=next\&\&next.mark);};

\node(locate23)[linenum] at ($(locate22.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate23.east)+(21pt,0pt)$) {\scriptsize next = next.next;};

\node(locate24)[linenum] at ($(locate23.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate24.east)+(14pt,0pt)$) {\scriptsize n.next = next;};

\node(locate24)[linenum] at ($(locate24.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate24.east)+(14pt,0pt)$) {\scriptsize return s;};



\node(bot)[linecode] at ($(pop10.east)+(0pt,-18pt)$) {};

\begin{pgfonlayer}{background}
\node[code-bg,fit=(pop-head1) (locate24) (code14) (code22)]{};
\end{pgfonlayer}
 


\end{tikzpicture}

\caption{\tt Timestamp Stack.}

\label{ts-stack:code}
\end{figure}

\begin{figure}[h]
\begin{tikzpicture}[]
\node(top){};
\node(top-head)[linecode] at ($(top.west)+(-60pt,0pt)$) {};
%%%%%%%%%%% struct %%%%%%%%%%%%%%%%
\node[linecode,anchor=south west](struct) at ($(top-head.east)+(-30pt,0pt)$) { \scriptsize struct Node \scriptsize \{};
%{struct Node(bool lock; int val; Node *next; bool mark);};
\node(struct1)[linecode] at ($(top-head.west)+(10pt,-5pt)$) {\scriptsize int data;\;\;\;\;\;\;};
\node(struct2)[linecode] at ($(top-head.west)+(10pt,-15pt)$) {\scriptsize Timestamp ts;};
\node(struct3)[linecode] at ($(top-head.west)+(10pt,-26pt)$) {\scriptsize Node* next;};
\node(struct4)[linecode] at ($(top-head.west)+(10pt,-37pt)$) {\scriptsize bool mark;};
\node(struct5)[linecode] at ($(top-head.west)+(0pt,-47pt)$) {\scriptsize \}};
\node(struct6)[linecode] at ($(top-head.west)+(0pt,-52pt)$) {}; 
\begin{pgfonlayer}{background}
 \node[code-bg,fit=(struct) (struct6) (struct1) (struct2)] {};
\end{pgfonlayer}


\node(locate-head1)[linecode] at ($(top-head.east)+(143pt,8pt)$) {\scriptsize int deq(Timestamp ts):};

\node(locate1)[linenum,anchor=west] at ($(locate-head1.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate1.east)+(0pt,0pt)$) {\scriptsize boolean success = false;};

\node(locate2)[linenum] at ($(locate1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate2.east)+(0pt,0pt)$) {\scriptsize int maxTS = 10000;};

\node(locate3)[linenum] at ($(locate2.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(locate3.east)+(0pt,0pt)$) {\scriptsize Node* youngest, myTop, n = null;};

\node(locate3a)[linenum] at ($(locate3.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(locate3a.east)+(0pt,0pt)$) {\scriptsize Node* empty[maxThreads];};

\node(locate4)[linenum] at ($(locate3a.east)+(0pt,-10pt)$) {};
\node(code4)[linecode] at ($(locate4.east)+(0pt,0pt)$) {\scriptsize while (!success)}; 

\node(locate5)[linenum] at ($(locate4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate5.east)+(7pt,0pt)$) {\scriptsize int k; };

\node(locate6)[linenum] at ($(locate5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate6.east)+(7pt,0pt)$) {\scriptsize for(int i=0; i<maxThreads; i++)};

\node(locate7)[linenum] at ($(locate6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate7.east)+(14pt,0pt)$) {\scriptsize myTop = pools[i]; n = myTop;};

\node(locate8)[linenum] at ($(locate7.east)+(0pt,-10pt)$) {};
\node(code8)[linecode] at ($(locate8.east)+(14pt,0pt)$) {\scriptsize while (n.mark \&\& n.next != n) n = n.next; };


\node(locate8a)[linenum] at ($(locate8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8a.east)+(14pt,0pt)$) {\scriptsize if(n = null)};


\node(locate8b)[linenum] at ($(locate8a.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8b.east)+(21pt,0pt)$) {\scriptsize empty[i] = pools[i];};

\node(locate8c)[linenum] at ($(locate8b.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate8c.east)+(21pt,0pt)$) {\scriptsize continue;};

\node(locate9)[linenum] at ($(locate8c.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9.east)+(14pt,0pt)$) {\scriptsize if(maxTS > n.ts)};

\node(locate10)[linenum] at ($(locate9.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate10.east)+(21pt,0pt)$) {\scriptsize maxTS = n.ts;};

\node(locate11)[linenum] at ($(locate10.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate11.east)+(21pt,0pt)$) {\scriptsize youngest = n;};

\node(locate12)[linenum] at ($(locate11.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate12.east)+(21pt,0pt)$) {\scriptsize k = i;};

\node(locate13)[linenum] at ($(locate12.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate13.east)+(7pt,0pt)$) {\scriptsize if (youngest != null)};

\node(locate14)[linenum] at ($(locate13.east)+(0pt,-10pt)$) {};
\node(code14)[linecode] at ($(locate14.east)+(14pt,0pt)$) {\scriptsize success= remove(pools[k],myTop, youngest);};

\node(locate15)[linenum] at ($(locate14.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate15.east)+(7pt,0pt)$) {\scriptsize if (youngest = null)};

\node(locate16)[linenum] at ($(locate15.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate16.east)+(14pt,0pt)$) {\scriptsize for(int i=0; i<maxThreads; i++)};

\node(locate17)[linenum] at ($(locate16.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate17.east)+(28pt,0pt)$) {\scriptsize if (pools[i] != empty[i]);};

\node(locate18)[linenum] at ($(locate17.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate18.east)+(35pt,0pt)$) {\scriptsize return NonEmpty;};


\node(locate19)[linenum] at ($(locate18.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate19.east)+(14pt,0pt)$) {\scriptsize return Empty;};

\node(locate25)[linenum] at ($(locate19.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate25.east)+(7pt,0pt)$) {\scriptsize return youngest.data;};




\node(bot)[linecode] at ($(locate25.east)+(0pt,-10pt)$) {};
\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head1)  (code8)  (bot) ]{};
 \end{pgfonlayer}

%%%%%%%%%% pop %%%%%%%%%%



%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(pop-head)[linecode][font={\small\tt},anchor=west] at 
($(top-head.east)+(-30pt,-122pt)$) 
{\scriptsize void enq(int d):};
\node(pop1)[linenum,anchor=west] at ($(pop-head.west)+(0pt,-10pt)$) {};
\node(linecode1)[linecode] at ($(pop1.east)+(0pt,0pt)$) 
{\scriptsize Node* new := new Node(d,-1,null,false);};

\node(pop2)[linenum] at ($(pop1.east)+(0pt,-10pt)$) {};
\node(linecode2)[linecode] at ($(pop2.east)+(0pt,0pt)$)
{\scriptsize new.next = pools[myID];};

\node(pop3)[linenum] at ($(pop2.east)+(0pt,-10pt)$) {};
\node(linecode3)[linecode] (code3a) at ($(pop3.east)+(0pt,0pt)$)
{\scriptsize pools[myID] = new;};

\node(pop4)[linenum] at ($(pop3.east)+(0pt,-10pt)$) {};
\node(linecode4)[linecode] at ($(pop4.east)+(0pt,0pt)$)
{\scriptsize  Timestamp t = new Timestamp();};

\node(pop5)[linenum] at ($(pop4.east)+(0pt,-10pt)$) {};
\node(linecode5)[linecode] at ($(pop5.east)+(0pt,0pt)$) 
{\scriptsize new.ts = t;};

\node(pop6)[linenum] at ($(pop5.east)+(0pt,-10pt)$) {};
\node(linecode6)[linecode] at ($(pop6.east)+(0pt,0pt)$) 
{\scriptsize Node* next = new.next;};

\node(pop7)[linenum] at ($(pop6.east)+(0pt,-10pt)$) {};
\node(linecode7)[linecode] at ($(pop7.east)+(0pt,0pt)$) 
{\scriptsize while (next.next != next $\&$ !next.mark)};

\node(pop8)[linenum] at ($(pop7.east)+(0pt,-10pt)$) {};
\node(linecode8)[linecode] at ($(pop8.east)+(7pt,0pt)$) 
{\scriptsize next = next.next;};

\node(pop9)[linenum] at ($(pop8.east)+(0pt,-10pt)$) {};
\node(linecode9)[linecode] at ($(pop9.east)+(0pt,0pt)$) 
{\scriptsize new.next = next;};

\node(pop10)[linenum] at ($(pop9.east)+(0pt,-10pt)$) {};
\node(linecode10)[linecode] at ($(pop10.east)+(0pt,0pt)$) 
{\scriptsize return new;};




\node(bot)[linecode] at ($(pop10.east)+(0pt,-18pt)$) {};

\begin{pgfonlayer}{background}
\node[code-bg,fit=(pop-head) (linecode1) (pop1) (bot)]{};
\end{pgfonlayer}
 
 
 
 %%%%%%%%%%% init %%%%%%%%%%%%%%%%
\node[linecode,anchor=south west](init) at ($(top-head.east)+(-30pt,-75pt)$) {\scriptsize init() :};
%{struct Node(bool lock; int val; Node *next; bool mark);};
\node(init1)[linecode] at ($(top-head.east)+(-30pt,-80pt)$) {\scriptsize \;\;\;Node* pools[maxThreads];};
\node(init2)[linecode] at ($(top-head.east)+(-30pt,-90pt)$) {\scriptsize \;\;\;for(int i=0; i<maxThreads; i++)\;\;\;\;\;\;};
\node(init4)[linecode] at ($(top-head.east)+(-30pt,-100pt)$) {\scriptsize \;\;\;\;\;\;\;pools[i].next = null;};

\node(bot)[linecode] at ($(init4.east)+(0pt,-4pt)$) {};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(init) (init4) (init2) (bot)] {};
\end{pgfonlayer}






%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(pop-head11)[linecode][font={\scriptsize \tt},anchor=west] at  ($(top-head.east)+(-25pt,-272pt)$) {\scriptsize Node remove(Node* pt, Node* t, Node* n)};


\node(locate14)[linenum] at ($(pop-head11.west)+(10pt,-10pt)$) {};
\node(code14)[linecode] at ($(locate14.east)+(0pt,0pt)$) {\scriptsize bool s = CAS(n.mark,false,true);};

\node(locate15)[linenum] at ($(locate14.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate15.east)+(7pt,0pt)$) {\scriptsize if (s)};

\node(locate16)[linenum] at ($(locate15.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate16.east)+(14pt,0pt)$) {\scriptsize CAS(pt, t, n);};

\node(locate17)[linenum] at ($(locate16.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate17.east)+(14pt,0pt)$) {\scriptsize if (t != n);};

\node(locate18)[linenum] at ($(locate17.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate18.east)+(21pt,0pt)$) {\scriptsize t.next = n;};


\node(locate19)[linenum] at ($(locate18.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate19.east)+(14pt,0pt)$) {\scriptsize t.next = n.next;};

\node(locate21)[linenum] at ($(locate19.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate21.east)+(14pt,0pt)$) {\scriptsize Node* next=n.next};

\node(locate22)[linenum] at ($(locate21.east)+(0pt,-10pt)$) {};
\node(code22)[linecode] at ($(locate22.east)+(14pt,0pt)$) {\scriptsize while (next.next != next \&\& next.mark);};

\node(locate23)[linenum] at ($(locate22.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate23.east)+(21pt,0pt)$) {\scriptsize next = next.next;};

\node(locate24)[linenum] at ($(locate23.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate24.east)+(14pt,0pt)$) {\scriptsize n.next = next;};

\node(locate24)[linenum] at ($(locate24.east)+(0pt,-10pt)$) {};
\node(code111)[linecode] at ($(locate24.east)+(14pt,0pt)$) {\scriptsize return s;};



\node(bot1)[linecode] at ($(pop10.east)+(0pt,-18pt)$) {};

\begin{pgfonlayer}{background}
\node[code-bg,fit=(pop-head11) (code14) (code111) (code22)]{};
\end{pgfonlayer}
 


\end{tikzpicture}

\caption{\tt Timestamp Queue.}

\label{ts-queue:code}
\end{figure}















\begin{figure}
\begin{tikzpicture}[]

%%%%%%%%%% locate %%%%%%%%%%
\node(locate){};
\node(locate-head)[linecode] at ($(locate.east)+(-90pt,-10pt)$) {\scriptsize <Node, Node> locate(int d):};

\node(locate-local)[linecode] at 
($(locate-head.west)+(0pt,-10pt)$) {\scriptsize local pred, curr};

\node(locate1)[linenum,anchor=west] at ($(locate-local.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate1.east)+(0pt,0pt)$) {\scriptsize while (true) };

\node(locate2)[linenum] at ($(locate1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate2.east)+(10pt,0pt)$) {\scriptsize pred := head;};

\node(locate3)[linenum] at ($(locate2.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate3.east)+(10pt,0pt)$) {\scriptsize curr := pred.next; };

\node(locate4)[linenum] at ($(locate3.east)+(0pt,-10pt)$) {};
\node(code4)[linecode] at ($(locate4.east)+(10pt,0pt)$) {\scriptsize while (curr.val < d) };

\node(locate5)[linenum] at ($(locate4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate5.east)+(20pt,0pt)$) {\scriptsize pred := curr; };

\node(locate6)[linenum] at ($(locate5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate6.east)+(20pt,0pt)$) {\scriptsize curr := curr.next};

\node(locate7)[linenum] at ($(locate6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate7.east)+(10pt,0pt)$) {\scriptsize lock(pred); lock(curr);};

\node(locate8)[linenum] at ($(locate7.east)+(0pt,-10pt)$) {};
\node(code8)[linecode] at ($(locate8.east)+(10pt,0pt)$) {\scriptsize if (! pred.mark \&\& };

\node(locate9)[linenum] at ($(locate8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9.east)+(27pt,0pt)$) {\scriptsize ! curr.mark\&\&};

\node(locate10)[linenum] at ($(locate9.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate10.east)+(27pt,0pt)$) {\scriptsize pred.next=curr)};

\node(locate11)[linenum] at ($(locate10.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate11.east)+(20pt,0pt)$) {\scriptsize return(pred,curr);};

\node(locate12)[linenum] at ($(locate11.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate12.east)+(10pt,0pt)$) {\scriptsize else};

\node(locate13)[linenum] at ($(locate12.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate13.east)+(20pt,0pt)$) {\scriptsize unlock(pred);};

\node(locate14)[linenum] at ($(locate13.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate14.east)+(20pt,0pt)$) {\scriptsize unlock(curr);};


\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head) (code4) (locate14) ]{};
 \end{pgfonlayer}




%%%%%%%%%% add %%%%%%%%%%


\node[anchor=west](add) at ($(locate.east)+(95pt,-20pt)$) {};
\node(add-head)[linecode] at (add) {\scriptsize bool add(int d):};

\node(add-local)[linecode,anchor=west] at 
($(add-head.west)+(10pt,-10pt)$) {local pred, curr, n, r};

\node(add1)[linenum,anchor=west] at ($(add-local.west)+(0pt,-10pt)$) {1};
\node[linecode] at ($(add1.east)+(0pt,0pt)$) {\scriptsize (pred,curr) := locate(d);};

\node(add2)[linenum] at ($(add1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add2.east)+(0pt,0pt)$) 
{\scriptsize if (curr.val <> d) };

\node(add3)[linenum] at ($(add2.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(add3.east)+(10pt,0pt)$) 
{\scriptsize n := };

\node(add3a)[linenum] at ($(add3.east)+(0pt,-10pt)$) {};
\node(code3a)[linecode] at ($(add3a.east)+(10pt,0pt)$) 
{\scriptsize new Node(0,d,curr,false);};

\node(add4)[linenum] at ($(add3a.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add4.east)+(10pt,0pt)$) 
{\scriptsize pred.next := n;};

\node(add5)[linenum] at ($(add4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add5.east)+(10pt,0pt)$) {\scriptsize r := true;};

\node(add6)[linenum] at ($(add5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add6.east)+(0pt,0pt)$) {\scriptsize else 
r := false;};


\node(add7)[linenum] at ($(add6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add7.east)+(0pt,0pt)$) {\scriptsize unlock(pred);};

\node(add8)[linenum] at ($(add7.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add8.east)+(0pt,0pt)$) {\scriptsize unlock(curr);};

\node(add9)[linenum] at ($(add8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(add9.east)+(0pt,0pt)$) {\scriptsize return r;};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(add-head) (code3a) (add9) ]{};
 \end{pgfonlayer}

%%%%%%%%%% rmv %%%%%%%%%%


%\node[linecode,anchor=west](rmv) at ($(locate.west)+(0pt,-100pt)$) {};
\node(rmv-head)[linecode][font={\small\tt},anchor=west] at ($(add-head.west)+(31pt,-140pt)$)  {\scriptsize bool rmv(int d):};

\node(rmv-local)[linecode] at 
($(rmv-head.west)+(0pt,-10pt)$) {\scriptsize local pred, curr, n, r};

\node(rmv1)[linenum,anchor=west] at ($(rmv-local.west)+(0pt,-10pt)$) {};
\node(code200)[linecode] at ($(rmv1.east)+(0pt,0pt)$) {\scriptsize (pred,curr) = locate(d);};

\node(rmv2)[linenum] at ($(rmv1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv2.east)+(0pt,0pt)$) {\scriptsize if (curr.val = d)};


\node(rmv3)[linenum] at ($(rmv2.east)+(0pt,-10pt)$) {};
\node(code3)[linecode] at ($(rmv3.east)+(10pt,0pt)$) 
{\scriptsize curr.mark = true;};

\node(rmv4)[linenum] at ($(rmv3.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv4.east)+(10pt,0pt)$) {\scriptsize n = curr.next;};

\node(rmv5)[linenum] at ($(rmv4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv5.east)+(10pt,0pt)$) {\scriptsize pred.next = n;};

\node(rmv6)[linenum] at ($(rmv5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv6.east)+(10pt,0pt)$) {\scriptsize r = true;};

\node(rmv7)[linenum] at ($(rmv6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv7.east)+(0pt,0pt)$) {\scriptsize else r = false;};


\node(rmv8)[linenum] at ($(rmv7.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv8.east)+(0pt,0pt)$) {\scriptsize unlock(pred);};

\node(rmv9)[linenum] at ($(rmv8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv9.east)+(0pt,0pt)$) {\scriptsize unlock(curr);};

\node(rmv10)[linenum] at ($(rmv9.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(rmv10.east)+(0pt,0pt)$) {\scriptsize return r;};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(rmv-head) (code3) (rmv10) (code200) ]{};
 \end{pgfonlayer}


%%%%%%%%%% ctn %%%%%%%%%%

%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(ctn-head)[linecode][font={\small\tt},anchor=west] at 
($(locate-head.west)+(-4pt,-170pt)$) 
{\scriptsize bool ctn(int d):};

\node(ctn-local)[linecode] at 
($(ctn-head.west)+(0pt,-10pt)$) {\scriptsize local curr};

\node(ctn1)[linenum,anchor=west] at ($(ctn-local.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn1.east)+(0pt,0pt)$) 
{\scriptsize curr := Head;};

\node(ctn2)[linenum] at ($(ctn1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn2.east)+(0pt,0pt)$)
{\scriptsize while (curr.val < d)};

\node(ctn3)[linenum] at ($(ctn2.east)+(0pt,-10pt)$) {};
\node[linecode] (code3a) at ($(ctn3.east)+(10pt,0pt)$)
{\scriptsize curr := curr.next};

\node(ctn4)[linenum] at ($(ctn3.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn4.east)+(0pt,0pt)$)
{\scriptsize b := curr.mark};

\node(ctn5)[linenum] at ($(ctn4.east)+(0pt,-10pt)$) {};
\node(code5)[linecode] at ($(ctn5.east)+(0pt,0pt)$) 
{\scriptsize if (! b \&\& curr.val = d) };

\node(ctn6)[linenum] at ($(ctn5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn6.east)+(10pt,0pt)$) 
{\scriptsize return true;};

\node(ctn7)[linenum] at ($(ctn6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn7.east)+(0pt,0pt)$) 
{\scriptsize else return false;};



\begin{pgfonlayer}{background}
 \node[code-bg,fit=(ctn-head) (code5) (ctn7)]{};
 \end{pgfonlayer}


%%%%%%%%%%% struct %%%%%%%%%%%%%%%%

\node[linecode,anchor=south west](struct) at ($(locate-head.north west)+(-4pt,8pt)$) 
{\scriptsize struct Node(bool lock; int val; Node *next; bool mark);};


\begin{pgfonlayer}{background}
 \node[code-bg,fit=(struct)]{};
 \end{pgfonlayer}


\end{tikzpicture}
\caption{\tt Lazy Set.}
\label{lazy:list:code}
\end{figure}






%%%%%%%%%OPTIMISTIC SKIPLIST%%%%%%%%%

\begin{figure}
\begin{tikzpicture}[]

%%%%%%%%%% locate %%%%%%%%%%
\node(locate){};
\node(locate-head-locate)[linecode] at ($(locate.east)+(-120pt,0pt)$) {\scriptsize locate(int v,Node* preds[], Node* succs[]):};

\node(locate-local)[linecode] at 
($(locate-head-locate.west)+(10pt,-10pt)$) {\scriptsize local lfound, pred, curr;};

\node(locate1)[linenum,anchor=west] at ($(locate-local.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate1.east)+(0pt,0pt)$) {\scriptsize pred = H; lfound = -1};

\node(locate2)[linenum] at ($(locate1.east)+(0pt,-10pt)$) {};
\node(locatecode1)[linecode] at ($(locate2.east)+(0pt,0pt)$) {\scriptsize for (int i = maxHeight; i >= 1; i-\;-);};

\node(locate3)[linenum] at ($(locate2.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate3.east)+(10pt,0pt)$) {\scriptsize curr = pred.next[i]; };

\node(locate4)[linenum] at ($(locate3.east)+(0pt,-10pt)$) {};
\node(code1499)[linecode] at ($(locate4.east)+(10pt,0pt)$) {\scriptsize while (curr.val < v) };

\node(locate5)[linenum] at ($(locate4.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate5.east)+(20pt,0pt)$) {\scriptsize pred = curr; };

\node(locate6)[linenum] at ($(locate5.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate6.east)+(20pt,0pt)$) {\scriptsize curr = curr.next[i]};

\node(locate7)[linenum] at ($(locate6.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate7.east)+(10pt,0pt)$) {\scriptsize if (lfound = 1 \&\& curr.val = v)};

\node(locate8)[linenum] at ($(locate7.east)+(0pt,-10pt)$) {};
\node(code888)[linecode] at ($(locate8.east)+(20pt,0pt)$) {\scriptsize lfound = i};

\node(locate9)[linenum] at ($(locate8.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate9.east)+(10pt,0pt)$) {\scriptsize preds[i] = pred;};

\node(locate10)[linenum] at ($(locate9.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(locate10.east)+(10pt,0pt)$) {\scriptsize currs[i] = curr};

\node(locate11)[linenum] at ($(locate10.east)+(0pt,-10pt)$) {};
\node(locatecode2)[linecode] at ($(locate11.east)+(0pt,0pt)$) {\scriptsize return lfound};

%\node(locate12)[linenum] at ($(locate11.east)+(0pt,-10pt)$) {10};
%\node[linecode] at ($(locate12.east)+(10pt,0pt)$) {\scriptsize else};
%
%\node(locate13)[linenum] at ($(locate12.east)+(0pt,-10pt)$) {11};
%\node[linecode] at ($(locate13.east)+(20pt,0pt)$) {\scriptsize unlock(p);};
%
%\node(locate14)[linenum] at ($(locate13.east)+(0pt,-10pt)$) {12};
%\node[linecode] at ($(locate14.east)+(20pt,0pt)$) {\scriptsize unlock(c);};
%

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head-locate) (locatecode1) (locatecode2)]{};
 \end{pgfonlayer}




%%%%%%%%%% add %%%%%%%%%%


\node[anchor=west](add) at ($(locate.east)+(75pt,0pt)$) {};
\node(add-head)[linecode] at (add) {\scriptsize add(int v):};
\node[linecode] at ($(add.east)+(0pt,-10pt)$)  {\scriptsize int level = randomLevel(MaxHeight);};
\node(addcode1)[linecode] at ($(add.east)+(0pt,-20pt)$)  {\scriptsize Node* preds[MaxHeight], succs[MaxHeight];\;\;\;\;\;\;\;\;\;\;\;\;};
\node[linecode] at ($(add.east)+(0pt,-30pt)$)  {\scriptsize while(true)};
\node[linecode] at ($(add.east)+(7pt,-40pt)$)  {\scriptsize int lfound = findnode(v, preds, succs);};
\node[linecode] at ($(add.east)+(7pt,-50pt)$)  {\scriptsize if (lfound != 1)};
\node[linecode] at ($(add.east)+(14pt,-60pt)$)  {\scriptsize        Node* nodeFound = succs[lfound]; };

\node[linecode] at ($(add.east)+(14pt,-70pt)$)  {\scriptsize       if (!nodeFound.marked)};\node[linecode] at ($(add.east)+(21pt,-80pt)$)  {\scriptsize          while (!nodeFound.fullyLinked) };
\node[linecode] at ($(add.east)+(21pt,-90pt)$)  {\scriptsize          return false; };

\node[linecode] at ($(add.east)+(14pt,-100pt)$)  {\scriptsize        continue; };
\node[linecode] at ($(add.east)+(14pt,-110pt)$)  {\scriptsize      int highestLocked = -1;};\node[linecode] at ($(add.east)+(14pt,-120pt)$)  {\scriptsize      try };\node[linecode] at ($(add.east)+(21pt,-130pt)$)  {\scriptsize         Node* pred, succ, prevPred = null;};\node[linecode] at ($(add.east)+(21pt,-140pt)$)  {\scriptsize         bool valid = true; };\node[linecode] at ($(add.east)+(21pt,-150pt)$)  {\scriptsize         for (int i = 0; valid\&\& };
 \node[linecode] at ($(add.east)+(35pt,-160pt)$)  {\scriptsize i<=level;i++)};\node[linecode] at ($(add.east)+(28pt,-170pt)$)  {\scriptsize 			pred = preds[i]; };\node[linecode] at ($(add.east)+(28pt,-180pt)$)  {\scriptsize 			succ = succs[i]; };\node[linecode] at ($(add.east)+(28pt,-190pt)$)  {\scriptsize 			if (pred != prevPred)};\node[linecode] at ($(add.east)+(35pt,-200pt)$)  {\scriptsize 			   pred.lock();};\node[linecode] at ($(add.east)+(35pt,-210pt)$)  {\scriptsize 			   highestLocked = i;};\node[linecode] at ($(add.east)+(35pt,-220pt)$)  {\scriptsize     		   prevPred = pred;};\node[linecode] at ($(add.east)+(28pt,-230pt)$)  {\scriptsize            valid = !pred.marked \&\& !succ.marked};
\node[linecode] at ($(add.east)+(55pt,-240pt)$)  {\scriptsize            \&\& pred.nexts[i]= succ;};
\node[linecode] at ($(add.east)+(21pt,-250pt)$)  {\scriptsize          if (!valid ) continue;};\node[linecode] at ($(add.east)+(21pt,-260pt)$)  {\scriptsize          Node* newNode = new Node(v,level);};\node[linecode] at ($(add.east)+(21pt,-270pt)$)  {\scriptsize 		 for (int j = 0; j <= level; j++)}; \node[linecode] at ($(add.east)+(28pt,-280pt)$)  {\scriptsize             newNode.nexts[j] = succs[j];};\node[linecode] at ($(add.east)+(28pt,-290pt)$)  {\scriptsize             preds[j].nexts[layer] = newNode;};\node[linecode] at ($(add.east)+(21pt,-300pt)$)  {\scriptsize          newNode.fullyLinked = true;};\node[linecode] at ($(add.east)+(21pt,-310pt)$)  {\scriptsize          return true;};\node(addcode2)[linecode] at ($(add.east)+(14pt,-320pt)$)  {\scriptsize       finally unlock(preds, highestLocked);};


\begin{pgfonlayer}{background}
 \node[code-bg,fit=(add-head) (addcode1) (addcode2) ]{};
 \end{pgfonlayer}

%%%%%%%%%% rmv %%%%%%%%%%


\node[linecode,anchor=west][linecode](rmv) at ($(locate.west)+(-120pt,-140pt)$) {};
\node(rmv-head)[linecode][font={\small\tt},anchor=west] at (rmv)  {\scriptsize rmv(int v):};\node[linecode] at ($(rmv.east)+(0pt,-10pt)$)  {\scriptsize Node* nodeToDelete = null;};\node[linecode] at ($(rmv.east)+(0pt,-20pt)$)  {\scriptsize bool isMarked = false;};\node[linecode] at ($(rmv.east)+(0pt,-30pt)$)  {\scriptsize int level = -1;};\node(rmvcode1)[linecode] at ($(rmv.east)+(0pt,-40pt)$)  {\scriptsize Node* preds[MaxHeight], succs[MaxHeight];};\node[linecode] at ($(rmv.east)+(0pt,-50pt)$)  {\scriptsize while (true)};\node[linecode] at ($(rmv.east)+(7pt,-60pt)$)  {\scriptsize int lFound = findNode(v, preds, succs);};\node[linecode] at ($(rmv.east)+(7pt,-70pt)$)  {\scriptsize if (isMarked || lFound != -1 \&\& };\node[linecode] at ($(rmv.east)+(14pt,-80pt)$)  {\scriptsize    (okToDelete (succs[lFound], lFound)))};\node[linecode] at ($(rmv.east)+(14pt,-90pt)$)  {\scriptsize    if (!isMarked)};\node[linecode] at ($(rmv.east)+(21pt,-100pt)$)  {\scriptsize       nodeToDelete = succs[lFound];};\node[linecode] at ($(rmv.east)+(21pt,-110pt)$)  {\scriptsize       topLayer = nodeToDelete.level;};\node[linecode] at ($(rmv.east)+(21pt,-120pt)$)  {\scriptsize       lock(nodeToDelete);};\node[linecode] at ($(rmv.east)+(21pt,-130pt)$)  {\scriptsize       if(nodeToDelete.marked);};\node[linecode] at ($(rmv.east)+(28pt,-140pt)$)  {\scriptsize 		  unlock(nodeToDelete);};\node[linecode] at ($(rmv.east)+(21pt,-150pt)$)  {\scriptsize        return false;};\node[linecode] at ($(rmv.east)+(21pt,-160pt)$)  {\scriptsize        nodeToDelete.marked = true;};\node[linecode] at ($(rmv.east)+(21pt,-170pt)$)  {\scriptsize        isMarked = true;};\node[linecode] at ($(rmv.east)+(14pt,-180pt)$)  {\scriptsize     int highestLocked = -1;};\node[linecode] at ($(rmv.east)+(14pt,-190pt)$)  {\scriptsize     try};\node[linecode] at ($(rmv.east)+(21pt,-200pt)$)  {\scriptsize        Node* pred, succ, prevPred = null;};\node[linecode] at ($(rmv.east)+(21pt,-210pt)$)  {\scriptsize        bool valid = true;};\node[linecode] at ($(rmv.east)+(21pt,-220pt)$)  {\scriptsize        for (int i = 0;valid \&\&li<=level; i++)};\node[linecode] at ($(rmv.east)+(28pt,-230pt)$)  {\scriptsize 			pred = preds[i];};\node[linecode] at ($(rmv.east)+(28pt,-240pt)$)  {\scriptsize 			succ = succs[i];};\node[linecode] at ($(rmv.east)+(28pt,-250pt)$)  {\scriptsize 		    if (pred != prevPred)};\node[linecode] at ($(rmv.east)+(35pt,-260pt)$)  {\scriptsize 			   lock(pred);};\node[linecode] at ($(rmv.east)+(28pt,-270pt)$)  {\scriptsize 			highestLocked = i;};\node[linecode] at ($(rmv.east)+(28pt,-280pt)$)  {\scriptsize 			prevPred = pred;};\node(rmvcode2)[linecode] at ($(rmv.east)+(28pt,-290pt)$)  {\scriptsize            valid = !pred.marked \&\& pred.next[i]==succ;};\node[linecode] at ($(rmv.east)+(21pt,-300pt)$)  {\scriptsize         if (!valid) continue;};\node[linecode] at ($(rmv.east)+(21pt,-310pt)$)  {\scriptsize         for (int j = level; j >= 0; j-\;-)};\node[linecode] at ($(rmv.east)+(28pt,-320pt)$)  {\scriptsize             preds[j].nexts[j] = nodeToDelete.nexts[j];};\node[linecode] at ($(rmv.east)+(21pt,-330pt)$)  {\scriptsize         unlock(nodeToDelete);};\node[linecode] at ($(rmv.east)+(21pt,-340pt)$)  {\scriptsize 		 return true;};\node[linecode] at ($(rmv.east)+(14pt,-350pt)$)  {\scriptsize      finally unlock(preds,highestLocked); };\node(rmvcode3)[linecode] at ($(rmv.east)+(7pt,-360pt)$)  {\scriptsize    else return false; };
%
\begin{pgfonlayer}{background}
 \node[code-bg,fit=(rmv-head) (rmvcode1) (rmvcode2) (rmvcode3) ]{};
 \end{pgfonlayer}


%%%%%%%%%% ctn %%%%%%%%%%

%\node[linecode](ctn) at ($(rmv.east)+(105pt,-50pt)$) {};
\node(ctn-head)[linecode][anchor=west] at 
($(locate.west)+(100pt,-350pt)$) 
{\scriptsize bool ctn(int v):};

\node(ctn-local)[linecode] at 
($(ctn-head.west)+(0pt,-10pt)$) {\scriptsize Node* preds[MaxHeight], succs[MaxHeight] ;};

\node(ctn1)[linenum,anchor=west] at ($(ctn-local.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn1.east)+(0pt,0pt)$) 
{\scriptsize int lFound = findNode ( v,preds,succs);};

\node(ctn2)[linenum] at ($(ctn1.east)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn2.east)+(0pt,0pt)$)
{\scriptsize return (lFound != -1};

\node(ctn3)[linenum] at ($(ctn2.east)+(0pt,-10pt)$) {};
\node[linecode] (code3a) at ($(ctn3.east)+(30pt,0pt)$)
{\scriptsize \&\& succs[lFound].fullyLinked};

\node(ctn4)[linenum] at ($(ctn3.east)+(30pt,-10pt)$) {};
\node(cntcode1)[linecode] at ($(ctn4.east)+(0pt,0pt)$)
{\scriptsize \&\& !succs[lFound].marked);};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(ctn-head) (ctn-local) (cntcode1)]{};
 \end{pgfonlayer}
 

\node(ctn-head2)[linecode][anchor=west] at 
($(locate.west)+(100pt,-440pt)$) 
{\scriptsize bool okToDelete(Node* candidate,int lFound):};

\node(ctn2)[linenum] at ($(ctn-head2.west)+(0pt,-10pt)$) {};
\node[linecode] at ($(ctn2.east)+(10pt,0pt)$)
{\scriptsize return (candidate.fullyLinked};

\node(ctn3)[linenum] at ($(ctn2.east)+(0pt,-10pt)$) {};
\node[linecode] (code3a) at ($(ctn3.east)+(30pt,0pt)$)
{\scriptsize \&\& candidate.topLayer=lFound};

\node(ctn4)[linenum] at ($(ctn3.east)+(30pt,-10pt)$) {};
\node(cntcode22)[linecode] at ($(ctn4.east)+(0pt,0pt)$)
{\scriptsize \&\&  !candidate.marked);};



\begin{pgfonlayer}{background}
 \node[code-bg,fit=(ctn-head2) (cntcode22)]{};
 \end{pgfonlayer}
 
 
%%%%%%%%%%% struct %%%%%%%%%%%%%%%%

\node[linecode,anchor=south west](struct) at ($(locate-head-locate.north)+(-80pt,10pt)$) 
{\scriptsize struct Node(int key; int topLayer; Node *next[]; bool marked; fullylinked;Lock lock);};


\begin{pgfonlayer}{background}
 \node[code-bg,fit=(struct)]{};
 \end{pgfonlayer}


\end{tikzpicture}
\caption{\tt Optimistic Skiplist.}
\label{lazy:list:code}
\end{figure}





























%%%%%%%%%LOCK-FREE SKIPLIST%%%%%%%%%

\begin{figure}
\begin{tikzpicture}[]

%%%%%%%%%% locate %%%%%%%%%%
\node(locate){};
\node(locate-head)[linecode] at ($(locate.west)+(-120pt,-10pt)$) {\scriptsize boolean find(int x, Node* preds[], Node* succs[]):};
\node[linecode] at ($(locate-head.west)+(0pt,-10pt)$)  {\scriptsize int mLevel = 0;};
\node[linecode] at ($(locate-head.west)+(0pt,-20pt)$)  {\scriptsize boolean marked[MAXLEVEL] = {false};};
\node[linecode] at ($(locate-head.west)+(0pt,-30pt)$)  {\scriptsize boolean snip;};
\node[linecode] at ($(locate-head.west)+(0pt,-40pt)$)  {\scriptsize Node* pred = null, curr = null, succ = null;};
\node[linecode] at ($(locate-head.west)+(0pt,-50pt)$)  {\scriptsize retry:};
\node[linecode] at ($(locate-head.west)+(7pt,-60pt)$)  {\scriptsize  while (true) };
\node[linecode] at ($(locate-head.west)+(14pt,-70pt)$)  {\scriptsize   pred = head; };
\node[linecode] at ($(locate-head.west)+(14pt,-80pt)$)  {\scriptsize   for (int i = MAXLEVEL; i >= mLevel; i-\;-) };
\node[linecode] at ($(locate-head.west)+(21pt,-90pt)$)  {\scriptsize    curr = pred.next[i]; };
\node[linecode] at ($(locate-head.west)+(21pt,-100pt)$)  {\scriptsize    while (true) };
\node[linecode] at ($(locate-head.west)+(28pt,-110pt)$)  {\scriptsize      succ = curr.next[i].get(marked); };
 \node[linecode] at ($(locate-head.west)+(28pt,-120pt)$)  {\scriptsize     while (marked[0]) };
 \node(1)[linecode] at ($(locate-head.west)+(28pt,-130pt)$)  {\scriptsize       s= CAS(pred.next[i],curr,succ,false,false); };
\node[linecode] at ($(locate-head.west)+(35pt,-140pt)$)  {\scriptsize        if (!s) continue retry; };
\node[linecode] at ($(locate-head.west)+(35pt,-150pt)$)  {\scriptsize        curr = pred.next[i]; };
\node[linecode] at ($(locate-head.west)+(35pt,-160pt)$)  {\scriptsize        succ = curr.next[i].get(marked); };
\node[linecode] at ($(locate-head.west)+(28pt,-170pt)$)  {\scriptsize      if (curr.key < x) };
\node[linecode] at ($(locate-head.west)+(35pt,-180pt)$)  {\scriptsize         pred = curr; curr = succ; };
\node[linecode] at ($(locate-head.west)+(28pt,-190pt)$)  {\scriptsize      else };
\node[linecode] at ($(locate-head.west)+(35pt,-200pt)$)  {\scriptsize         break; };
\node[linecode] at ($(locate-head.west)+(21pt,-210pt)$)  {\scriptsize    preds[i] = pred; };
\node[linecode] at ($(locate-head.west)+(21pt,-220pt)$)  {\scriptsize    succs[i] = curr; };
\node(2)[linecode] at ($(locate-head.west)+(14pt,-230pt)$)  {\scriptsize   return (curr.key == key); };


\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head) (1) (2)]{};
 \end{pgfonlayer}
 
 
%%%%%%%%%% add %%%%%%%%%%

\node[anchor=west](add) at ($(locate.east)+(77pt,-20pt)$) {};
\node(add-head)[linecode] at (add) {\scriptsize add(int v):};
\node[linecode] at ($(add.east)+(0pt,-10pt)$)  {\scriptsize int topLevel = randomLevel();};
\node[linecode] at ($(add.east)+(0pt,-20pt)$)  {\scriptsize  int mLevel = 0; };
\node[linecode] at ($(add.east)+(0pt,-30pt)$)  {\scriptsize  Node* preds[MAXLEVEL+1]; };
\node[linecode] at ($(add.east)+(0pt,-40pt)$)  {\scriptsize  Node* succs[MAXLEVEL+1]; };
\node[linecode] at ($(add.east)+(0pt,-50pt)$)  {\scriptsize while (true) };
\node[linecode] at ($(add.east)+(7pt,-60pt)$)  {\scriptsize    boolean found = find(x, preds, succs); };
\node[linecode] at ($(add.east)+(7pt,-70pt)$)  {\scriptsize    if (found)};
\node[linecode] at ($(add.east)+(14pt,-80pt)$) {\scriptsize      return false;};
\node[linecode] at ($(add.east)+(7pt,-90pt)$)  {\scriptsize    else};
\node[linecode] at ($(add.east)+(14pt,-100pt)$) {\scriptsize      Node* new = new Node(x, topLevel);};
\node[linecode] at ($(add.east)+(14pt,-110pt)$) {\scriptsize      for (int i= mLevel;level<=topLevel;i++)};
\node[linecode] at ($(add.east)+(21pt,-120pt)$) {\scriptsize          Node* succ = succs[i];};
\node[linecode] at ($(add.east)+(21pt,-130pt)$) {\scriptsize          new.next[i].set(succ, false);};
\node[linecode] at ($(add.east)+(14pt,-140pt)$) {\scriptsize      Node* pred = preds[mLevel];};
\node[linecode] at ($(add.east)+(14pt,-150pt)$) {\scriptsize      Node* succ = succs[mLevel];};
\node[linecode] at ($(add.east)+(14pt,-160pt)$) {\scriptsize      new.next[mLevel].set(succ, false);};
\node(1)[linecode] at ($(add.east)+(14pt,-170pt)$) {\scriptsize      if (!CAS(pred.next[mLevel],succ,new,false,false))};
\node[linecode] at ($(add.east)+(21pt,-180pt)$) {\scriptsize  		  continue;};
\node[linecode] at ($(add.east)+(14pt,-190pt)$) {\scriptsize      for (int i=mLevel+1;i<=topLevel;i++)};
\node[linecode] at ($(add.east)+(21pt,-200pt)$) {\scriptsize         while (true)};
\node[linecode] at ($(add.east)+(28pt,-210pt)$) {\scriptsize           pred = preds[i];};
\node[linecode] at ($(add.east)+(28pt,-220pt)$) {\scriptsize           succ = succs[i];};
\node(2)[linecode] at ($(add.east)+(28pt,-230pt)$) {\scriptsize           if (CAS(pred.next[i],succ,new,false,false))};
\node[linecode] at ($(add.east)+(35pt,-240pt)$) {\scriptsize               break;};
\node[linecode] at ($(add.east)+(28pt,-250pt)$) {\scriptsize           find(x,preds,succs);};
\node(3)[linecode] at ($(add.east)+(14pt,-260pt)$) {\scriptsize      return true;};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(add-head) (1) (2) (3)]{};
 \end{pgfonlayer}
%%%%%%%%%% rmv %%%%%%%%%%

\node[linecode,anchor=west](rmv) at ($(locate.west)+(-120pt,-260pt)$) {};
\node(rmv-head)[linecode][anchor=west] at (rmv)  {\scriptsize bool rmv(int x):};\node[linecode] at ($(rmv.east)+(0pt,-10pt)$)  {\scriptsize Node* nodeToDelete = null;};\node[linecode] at ($(rmv.east)+(0pt,-20pt)$)  {\scriptsize   int mLevel = 0;};
\node[linecode] at ($(rmv.east)+(0pt,-30pt)$)  {\scriptsize   Node* preds[MAXLEVEL+1];};
\node[linecode] at ($(rmv.east)+(0pt,-40pt)$)  {\scriptsize   Node* succs[MAXLEVEL+1];};
\node[linecode] at ($(rmv.east)+(0pt,-50pt)$)  {\scriptsize   Node* succ;};
\node[linecode] at ($(rmv.east)+(0pt,-60pt)$)  {\scriptsize   while (true)}; 
\node[linecode] at ($(rmv.east)+(7pt,-70pt)$)  {\scriptsize     boolean found = find(x, preds, succs);};
\node[linecode] at ($(rmv.east)+(7pt,-80pt)$)  {\scriptsize     if (!found)};
\node[linecode] at ($(rmv.east)+(14pt,-90pt)$)  {\scriptsize        return false;};
\node[linecode] at ($(rmv.east)+(7pt,-100pt)$)  {\scriptsize     else};
\node[linecode] at ($(rmv.east)+(14pt,-110pt)$)  {\scriptsize        Node* node = succs[mLevel];};
\node(1)[linecode] at ($(rmv.east)+(14pt,-120pt)$)  {\scriptsize        for (int i = node.topLevel; i >= mLevel+1; i-\;-)};
\node[linecode] at ($(rmv.east)+(21pt,-130pt)$)  {\scriptsize             boolean marked[MAXLEVEL+1] = {false}; };
\node[linecode] at ($(rmv.east)+(21pt,-140pt)$)  {\scriptsize             succ = node.next[i].get(marked); }; 
\node[linecode] at ($(rmv.east)+(21pt,-150pt)$)  {\scriptsize             while (!marked[0])  };
\node[linecode] at ($(rmv.east)+(28pt,-160pt)$)  {\scriptsize               node.next[i].attemptMark(succ, true); };
\node[linecode] at ($(rmv.east)+(28pt,-170pt)$)  {\scriptsize               succ = node.next[i].get(marked); };
\node[linecode] at ($(rmv.east)+(14pt,-180pt)$)  {\scriptsize         boolean marked[MAXLEVEL+1] = {false}; };
\node[linecode] at ($(rmv.east)+(14pt,-190pt)$)  {\scriptsize         succ = node.next[mLevel].get(marked); };
\node[linecode] at ($(rmv.east)+(14pt,-200pt)$)  {\scriptsize         while (true)  };
\node[linecode] at ($(rmv.east)+(21pt,-210pt)$)  {\scriptsize           boolean iMarkedIt = };
\node[linecode] at ($(rmv.east)+(21pt,-220pt)$)  {\scriptsize           CAS(node.next[mLevel],succ, succ, false, true); };
\node[linecode] at ($(rmv.east)+(21pt,-230pt)$)  {\scriptsize           succ = succs[mLevel].next[mLevel].get(marked); };
\node[linecode] at ($(rmv.east)+(21pt,-240pt)$)  {\scriptsize           if (iMarkedIt)};
\node[linecode] at ($(rmv.east)+(28pt,-250pt)$)  {\scriptsize              find(x, preds, succs); };
\node[linecode] at ($(rmv.east)+(28pt,-260pt)$)  {\scriptsize              return true; };
\node(2)[linecode] at ($(rmv.east)+(21pt,-270pt)$)  {\scriptsize           else if (marked[0]) return false; };

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(rmv-head) (1) (2)]{};
 \end{pgfonlayer}

%%%%%%%%%% ctn %%%%%%%%%%

\node(cnt-head)[linecode][anchor=west] at 
($(locate.west)+(120pt,-330pt)$) 
{\scriptsize bool ctn(int x):};
\node[linecode] at ($(cnt-head.west)+(0pt,-10pt)$)  {\scriptsize int bottomLevel = 0;};
\node[linecode] at ($(cnt-head.west)+(0pt,-20pt)$)  {\scriptsize bool marked[MAXLEVEL] = {false};};
\node(1)[linecode] at ($(cnt-head.west)+(0pt,-30pt)$)  {\scriptsize Node* pred = head, curr = null, succ = null;};
\node[linecode] at ($(cnt-head.west)+(0pt,-40pt)$)  {\scriptsize for (int i = MAXLEVEL; i >= mLevel; i-\;-) };
\node[linecode] at ($(cnt-head.west)+(7pt,-50pt)$)  {\scriptsize    curr = pred.next[i]; };
\node[linecode] at ($(cnt-head.west)+(7pt,-60pt)$)  {\scriptsize    while (true) };
\node[linecode] at ($(cnt-head.west)+(14pt,-70pt)$)  {\scriptsize      succ = curr.next[i].get(marked); };
\node[linecode] at ($(cnt-head.west)+(14pt,-80pt)$)  {\scriptsize      while (marked[0]) };
 \node[linecode] at ($(cnt-head.west)+(21pt,-90pt)$)  {\scriptsize       curr = pred.next[i]; };
\node[linecode] at ($(cnt-head.west)+(21pt,-100pt)$)  {\scriptsize        succ = curr.next[i].get(marked); };
\node[linecode] at ($(cnt-head.west)+(14pt,-110pt)$)  {\scriptsize     if (curr.key < x) };
\node[linecode] at ($(cnt-head.west)+(21pt,-120pt)$)  {\scriptsize       pred = curr; };
\node[linecode] at ($(cnt-head.west)+(21pt,-130pt)$)  {\scriptsize       curr = succ; };
\node[linecode] at ($(cnt-head.west)+(14pt,-140pt)$)  {\scriptsize      else };
\node[linecode] at ($(cnt-head.west)+(21pt,-150pt)$)  {\scriptsize        break; };
\node(2)[linecode] at ($(cnt-head.west)+(0pt,-160pt)$)  {\scriptsize return (curr.key == v); };

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(cnt-head) (1) (2)]{};
 \end{pgfonlayer}

%%%%%%%%%%% struct %%%%%%%%%%%%%%%%

\node[linecode,anchor=south west](struct) at ($(locate-head.north west)+(-4pt,8pt)$) 
{\scriptsize struct Node(int key; int topLayer; Node *next[]; bool marked);};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(struct)]{};
 \end{pgfonlayer}

\end{tikzpicture}
\caption{\tt Lock-free Skiplist.}
\label{fig:lockfreeskiplist}
\end{figure}




%%%%%%%%PRIORITY QUEUE SKIPLIST%%%%%%%%%%

%%%%%%%%%LOCK-FREE SKIPLIST%%%%%%%%%
\newpage
\begin{figure}
\begin{tikzpicture}[]

%%%%%%%%%% locate %%%%%%%%%%
\node(locate){};
\node(locate-head)[linecode] at ($(locate.west)+(-120pt,-10pt)$) {\scriptsize Node * getLock(node* node1,int key,int level):};
\node[linecode] at ($(locate-head.west)+(0pt,-10pt)$)  {\scriptsize node2 = node1.next[level];};
\node[linecode] at ($(locate-head.west)+(0pt,-20pt)$)  {\scriptsize while (node2.key < key)};
\node[linecode] at ($(locate-head.west)+(7pt,-30pt)$)  {\scriptsize node1 = node2;};
\node[linecode] at ($(locate-head.west)+(7pt,-40pt)$)  {\scriptsize node2 = node1.next[level];};
\node[linecode] at ($(locate-head.west)+(0pt,-50pt)$)  {\scriptsize lock(node1, level);};
\node[linecode] at ($(locate-head.west)+(0pt,-60pt)$)  {\scriptsize node2 = node1.next[level];};
\node[linecode] at ($(locate-head.west)+(0pt,-70pt)$)  {\scriptsize while (node2.key < key); };
\node[linecode] at ($(locate-head.west)+(7pt,-80pt)$)  {\scriptsize   unlock(node1, level); };
\node[linecode] at ($(locate-head.west)+(7pt,-90pt)$)  {\scriptsize    node1 = node2; };
\node[linecode] at ($(locate-head.west)+(7pt,-100pt)$)  {\scriptsize   lock(node1, level); };
\node[linecode] at ($(locate-head.west)+(7pt,-110pt)$)  {\scriptsize      node2 = node1.next[level]; };
 \node(2)[linecode] at ($(locate-head.west)+(0pt,-120pt)$)  {\scriptsize     return node1; };

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(locate-head) (2)]{};
 \end{pgfonlayer}
%%%%%%%%%% add %%%%%%%%%%

\node[anchor=west](add) at ($(locate.east)+(75pt,-20pt)$) {};
\node(add-head)[linecode] at (add) {\scriptsize int Insert(key key, value value):};
\node[linecode] at ($(add.east)+(0pt,-10pt)$)  {\scriptsize node1 = head;};
\node[linecode] at ($(add.east)+(0pt,-20pt)$)  {\scriptsize  for (int i= MaxLevel; i > 0; i--) };
\node[linecode] at ($(add.east)+(7pt,-30pt)$)  {\scriptsize  node2 = node1.next[i]; };
\node[linecode] at ($(add.east)+(7pt,-40pt)$)  {\scriptsize  while (node2.key > key) };
\node[linecode] at ($(add.east)+(14pt,-50pt)$)  {\scriptsize node1 = node2; };
\node[linecode] at ($(add.east)+(14pt,-60pt)$)  {\scriptsize    node2 = node2.next[i]; };
\node[linecode] at ($(add.east)+(0pt,-70pt)$)  {\scriptsize    savedNodes[i] = node1;};
\node[linecode] at ($(add.east)+(0pt,-80pt)$) {\scriptsize     node1 = getLock(node1, key, 1);};
\node[linecode] at ($(add.east)+(0pt,-90pt)$)  {\scriptsize    node2 = node1.next[i];};
\node[linecode] at ($(add.east)+(0pt,-100pt)$) {\scriptsize      if (node2.key = key)};
\node[linecode] at ($(add.east)+(7pt,-110pt)$) {\scriptsize      node2.value = value;};
\node[linecode] at ($(add.east)+(7pt,-120pt)$) {\scriptsize          unlock(node1, 1);};
\node[linecode] at ($(add.east)+(7pt,-130pt)$) {\scriptsize          return UPDATED;};
\node[linecode] at ($(add.east)+(0pt,-140pt)$) {\scriptsize      level = randomLevel();};
\node[linecode] at ($(add.east)+(0pt,-150pt)$) {\scriptsize      newNode = newNode(level, key, value);};
\node[linecode] at ($(add.east)+(0pt,-160pt)$) {\scriptsize     newNode.timeStamp = MAXTIME;};
\node[linecode] at ($(add.east)+(0pt,-170pt)$) {\scriptsize    lock(newNode)};
\node[linecode] at ($(add.east)+(0pt,-180pt)$) {\scriptsize  	for (i = 1; i <= level; i++)};
\node[linecode] at ($(add.east)+(7pt,-190pt)$) {\scriptsize      if (i != 1)};
\node(1)[linecode] at ($(add.east)+(14pt,-200pt)$) {\scriptsize         node1 = getLock(savedNodes[i], key, i);};
\node[linecode] at ($(add.east)+(7pt,-210pt)$) {\scriptsize           newNode.next[i] = node1.next[i];};
\node[linecode] at ($(add.east)+(7pt,-220pt)$) {\scriptsize           node1.next[i] = newNode;};
\node[linecode] at ($(add.east)+(7pt,-230pt)$) {\scriptsize           unlock(node1, i);};
\node[linecode] at ($(add.east)+(0pt,-240pt)$) {\scriptsize              unlock(newNode);};
\node[linecode] at ($(add.east)+(0pt,-250pt)$) {\scriptsize           newNode.timeStamp = getTime();};
\node(2)[linecode] at ($(add.east)+(0pt,-260pt)$) {\scriptsize      return INSERTED;};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(add-head) (1) (2)]{};
 \end{pgfonlayer}
%%%%%%%%%% rmv %%%%%%%%%%

\node[linecode,anchor=west](rmv) at ($(locate.west)+(-120pt,-160pt)$) {};
\node(rmv-head)[linecode][font={\small\tt},anchor=west] at (rmv)  {\scriptsize int DeleteMin(value value)):};\node[linecode] at ($(rmv.east)+(0pt,-10pt)$)  {\scriptsize time = getTime();};\node[linecode] at ($(rmv.east)+(0pt,-20pt)$)  {\scriptsize node1 = head.next[1];};
\node[linecode] at ($(rmv.east)+(0pt,-30pt)$)  {\scriptsize while (node1 != tail) };
\node[linecode] at ($(rmv.east)+(7pt,-40pt)$)  {\scriptsize   if (node1.timeStamp < time)};
\node[linecode] at ($(rmv.east)+(14pt,-50pt)$)  {\scriptsize      marked = SWAP(node1.deleted, true);};
\node[linecode] at ($(rmv.east)+(14pt,-60pt)$)  {\scriptsize      if (marked = FALSE) break;}; 
\node[linecode] at ($(rmv.east)+(14pt,-70pt)$)  {\scriptsize      node1 = node1.next[1]; };
\node[linecode] at ($(rmv.east)+(0pt,-80pt)$)  {\scriptsize if (node1 != tail)};
\node[linecode] at ($(rmv.east)+(7pt,-90pt)$)  {\scriptsize   value = node1.value;};
\node[linecode] at ($(rmv.east)+(7pt,-100pt)$)  {\scriptsize   key = node1.key;};
\node[linecode] at ($(rmv.east)+(7pt,-110pt)$)  {\scriptsize  return EMPTY;};
\node[linecode] at ($(rmv.east)+(0pt,-120pt)$)  {\scriptsize  node1 = head;   };
\node[linecode] at ($(rmv.east)+(0pt,-130pt)$)  {\scriptsize   for (i = MaxLevel; i > 0; i-\;-) };
\node[linecode] at ($(rmv.east)+(7pt,-140pt)$)  {\scriptsize   node2 = node1.next[i];}; 
\node[linecode] at ($(rmv.east)+(7pt,-150pt)$)  {\scriptsize   while (node2.key > key)};
\node[linecode] at ($(rmv.east)+(14pt,-160pt)$)  {\scriptsize  node1 = node2;};
\node[linecode] at ($(rmv.east)+(14pt,-170pt)$)  {\scriptsize  node2 = node2.next[i];};
\node[linecode] at ($(rmv.east)+(7pt,-180pt)$)  {\scriptsize  savedNodes[i] = node1;};
\node[linecode] at ($(rmv.east)+(0pt,-190pt)$)  {\scriptsize  node2 = node1;};
\node[linecode] at ($(rmv.east)+(0pt,-200pt)$)  {\scriptsize   while (node2.key != key)};
\node[linecode] at ($(rmv.east)+(7pt,-210pt)$)  {\scriptsize  node2 = node2.next[1];};
\node[linecode] at ($(rmv.east)+(7pt,-220pt)$)  {\scriptsize  lock(node2);};
\node[linecode] at ($(rmv.east)+(7pt,-230pt)$)  {\scriptsize  for (i = node2.level; i > 0; i-\;-)};
\node(1)[linecode] at ($(rmv.east)+(7pt,-240pt)$)  {\scriptsize  node1 = getLock(savedNodes[i], key, i);};
\node[linecode] at ($(rmv.east)+(7pt,-250pt)$)  {\scriptsize  lock(node2, i);};
\node[linecode] at ($(rmv.east)+(7pt,-260pt)$)  {\scriptsize  node1.next[i] = node2.next[i];};
\node[linecode] at ($(rmv.east)+(7pt,-270pt)$)  {\scriptsize  node2.next[i] = node1;};

\node[linecode] at ($(rmv.east)+(7pt,-280pt)$)  {\scriptsize  unlock(node2, i);};
\node[linecode] at ($(rmv.east)+(0pt,-290pt)$)  {\scriptsize  unlock(node1, i);};
\node[linecode] at ($(rmv.east)+(0pt,-300pt)$)  {\scriptsize  unlock(node2);};
\node(2)[linecode] at ($(rmv.east)+(0pt,-310pt)$)  {\scriptsize return DELETE;};

\begin{pgfonlayer}{background}
 \node[code-bg,fit=(rmv-head) (1) (2)]{};
 \end{pgfonlayer}
%%%%%%%%%%% struct %%%%%%%%%%%%%%%%

\node[linecode,anchor=south west](struct) at ($(locate-head.north west)+(-4pt,8pt)$) 
{\scriptsize struct Node(int key; int level; Node *next[]; value value; Timestamp timestamp );};

\end{tikzpicture}
\caption{\tt SkiplistBased Concurrent Priority Queues.}
\label{fig:pqskiplist}
\end{figure}
 


	
