\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\lstset{ %
  backgroundcolor=\color{white},   % choose the background color
  basicstyle=\footnotesize,        % size of fonts used for the code
  breaklines=true,                 % automatic line breaking only at whitespace
  captionpos=b,                    % sets the caption-position to bottom
  commentstyle=\color{mygreen},    % comment style
  escapeinside={\%*}{*)},          % if you want to add LaTeX within your code
  keywordstyle=\color{blue},       % keyword style
  stringstyle=\color{mymauve},     % string literal style
}

\begin{lstlisting}[language=C]
struct Node{
  int data;
  Timestamp ts;
  Node* next; 
  boolean mark;
};

Node* pools[maxThreads]; 

void init () {
  for(int Node* i=0; i<maxThreads; i++)
    pools[i].next = null;
}

Node* push(int d) {
   Node* n = new Node(d,-1,null,false); 
   n.next = pools[myID];
   pools[myID] = n; 
   Timestamp t = new Timestamp();
   n.ts = t;
   Node* next = n.next; // Unlinking
   while (next.next != next && !next.mark)
         next = next.next;
   n.next = next;
  return n;
}

int pop() {
  boolean success = false; 
  int maxTS = -1;
  Node* youngest = null; 
  while (!success) {
    int k;
    for(int Node* i=0; i<maxThreads; i++){
     mytop = pools[i];
     while (n.mark && n.next != n) n.next;
     if(maxTS < n.ts) {
         maxTS = n.ts; 
         youngest = n;
         k = i;
     } 
    }
    if (youngest != null) 
    success= CAS(youngest.mark,false,true);
    CAS(pools[k], myTop, youngest);
    // Unlink nodes before node in the list.
    if (myTop != youngest) 
       myTop.next = youngest;
     pools[k].next = youngest.next;
     // Unlink nodes after node in the list.
     Node* next=youngest.next
     while (next.next != next && next.mark)
        next = next.next;
     youngest.next = next;
  }
  return youngest.data;
\end{lstlisting}